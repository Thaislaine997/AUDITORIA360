<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AUDITORIA360 - Complete Demo</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f5f5f5; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #1f2937; margin-bottom: 30px; text-align: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; }
        .section { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 20px; }
        .section h2 { color: #374151; margin-top: 0; font-size: 18px; }
        .section.full-width { grid-column: 1 / -1; }
        button { background: #3b82f6; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin: 4px; font-size: 14px; }
        button:hover { background: #2563eb; }
        button.green { background: #059669; } button.green:hover { background: #047857; }
        button.purple { background: #7c3aed; } button.purple:hover { background: #6d28d9; }
        button.red { background: #dc2626; } button.red:hover { background: #b91c1c; }
        button.orange { background: #ea580c; } button.orange:hover { background: #c2410c; }
        .success { color: #059669; } .error { color: #dc2626; } .warning { color: #d97706; } .info { color: #3b82f6; }
        select, input { padding: 8px; margin: 4px; border: 1px solid #d1d5db; border-radius: 4px; }
        .card { border: 1px solid #e5e7eb; border-radius: 6px; padding: 12px; margin: 8px 0; background: #f9fafb; }
        .small-card { font-size: 14px; padding: 8px; }
        pre { background: #f3f4f6; padding: 8px; border-radius: 4px; overflow-x: auto; font-size: 12px; max-height: 200px; overflow-y: auto; }
        .progress { background: #e5e7eb; border-radius: 4px; height: 6px; margin: 4px 0; }
        .progress-bar { background: #059669; height: 100%; border-radius: 4px; transition: width 0.3s; }
        .task-item { padding: 2px 0; font-size: 12px; }
        .completed { color: #059669; } .pending { color: #d97706; }
        .upload-area { border: 2px dashed #d1d5db; border-radius: 8px; padding: 20px; text-align: center; margin: 10px 0; }
        .upload-area:hover { border-color: #3b82f6; background: #f8fafc; }
        input[type="file"] { margin: 10px 0; }
        .status-badge { padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .status-processing { background: #dbeafe; color: #1e40af; }
        .status-completed { background: #dcfce7; color: #166534; }
        .status-error { background: #fecaca; color: #991b1b; }
        .risk-low { color: #059669; } .risk-medium { color: #d97706; } .risk-high { color: #dc2626; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ AUDITORIA360 - Complete Ecosystem Demo</h1>
        
        <div class="grid">
            <!-- API Status -->
            <div class="section">
                <h2>üîó System Status</h2>
                <div id="api-status"><div class="info">Checking API...</div></div>
                <button onclick="checkAPIStatus()">Refresh Status</button>
            </div>

            <!-- Quick Stats -->
            <div class="section">
                <h2>üìä Quick Stats</h2>
                <div id="quick-stats"><div class="info">Loading stats...</div></div>
            </div>

            <!-- Templates Management -->
            <div class="section full-width">
                <h2>üìã Template Management & Monthly Controls</h2>
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 300px;">
                        <h3>Available Templates</h3>
                        <div id="templates-list"><div class="info">Loading templates...</div></div>
                    </div>
                    <div style="flex: 2; min-width: 400px;">
                        <h3>Monthly Controls - 
                            <select id="year-select" onchange="loadMonthlyControls()">
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                            </select>
                            <select id="month-select" onchange="loadMonthlyControls()">
                                <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option>
                                <option value="4">Apr</option><option value="5">May</option><option value="6">Jun</option>
                                <option value="7">Jul</option><option value="8" selected>Aug</option><option value="9">Sep</option>
                                <option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option>
                            </select>
                        </h3>
                        <div id="controls-summary"></div>
                        <div id="controls-list"></div>
                    </div>
                </div>
            </div>

            <!-- Payroll Audit -->
            <div class="section">
                <h2>üí∞ Payroll Audit (IA-Powered)</h2>
                <div class="upload-area" onclick="document.getElementById('payroll-file').click()">
                    <div>üìÑ Click to upload payroll PDF</div>
                    <div style="font-size: 12px; color: #6b7280;">AI will analyze and detect discrepancies</div>
                </div>
                <input type="file" id="payroll-file" accept=".pdf" style="display: none;" onchange="uploadPayrollPDF()">
                <div>
                    Company: <select id="payroll-empresa">
                        <option value="1">Empresa Alpha LTDA</option>
                        <option value="2">Empresa Beta LTDA</option>
                        <option value="3">Empresa Gamma LTDA</option>
                    </select>
                    Month: <select id="payroll-month">
                        <option value="1">Jan</option><option value="2">Feb</option><option value="8" selected>Aug</option>
                        <option value="12">Dec</option>
                    </select>
                    Year: <input type="number" id="payroll-year" value="2025" style="width: 80px;">
                </div>
                <div id="payroll-results"></div>
            </div>

            <!-- Legislation Management -->
            <div class="section">
                <h2>‚öñÔ∏è Legislation Management (AI Extract)</h2>
                <div class="upload-area" onclick="document.getElementById('legislation-file').click()">
                    <div>üìö Upload legislation PDF</div>
                    <div style="font-size: 12px; color: #6b7280;">AI will extract and structure key data</div>
                </div>
                <input type="file" id="legislation-file" accept=".pdf" style="display: none;" onchange="uploadLegislationPDF()">
                <div id="legislation-results"></div>
            </div>

            <!-- Syndicates & CCTs -->
            <div class="section">
                <h2>üèõÔ∏è Syndicates & CCTs</h2>
                <div id="syndicates-list"><div class="info">Loading syndicates...</div></div>
                <button class="green" onclick="loadSyndicates()">Load Syndicates</button>
                <button class="purple" onclick="loadCCTs()">Load CCTs</button>
                <div id="ccts-list"></div>
            </div>

            <!-- Risk Analysis -->
            <div class="section">
                <h2>‚ö†Ô∏è AI Risk Analysis</h2>
                <div>
                    <select id="risk-empresa">
                        <option value="1">Empresa Alpha LTDA</option>
                        <option value="2">Empresa Beta LTDA</option>
                        <option value="3">Empresa Gamma LTDA</option>
                    </select>
                    <button class="red" onclick="analyzeRisk()">Analyze Risk</button>
                </div>
                <div id="risk-results"></div>
            </div>
        </div>
    </div>

    <script>
        // Simple HTTP client
        const http = {
            async get(url) {
                const response = await fetch('http://localhost:8001' + url);
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                return { data: await response.json() };
            },
            async post(url, data) {
                const response = await fetch('http://localhost:8001' + url, {
                    method: 'POST',
                    headers: data instanceof FormData ? {} : { 'Content-Type': 'application/json' },
                    body: data instanceof FormData ? data : JSON.stringify(data)
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: response.statusText }));
                    const error = new Error(`HTTP ${response.status}`);
                    error.response = { data: errorData };
                    throw error;
                }
                return { data: await response.json() };
            },
            async patch(url) {
                const response = await fetch('http://localhost:8001' + url, { method: 'PATCH' });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: response.statusText }));
                    const error = new Error(`HTTP ${response.status}`);
                    error.response = { data: errorData };
                    throw error;
                }
                return { data: await response.json() };
            }
        };

        async function checkAPIStatus() {
            const statusDiv = document.getElementById('api-status');
            try {
                statusDiv.innerHTML = '<div class="info">üîÑ Checking API...</div>';
                const response = await http.get('/health');
                statusDiv.innerHTML = `<div class="success">‚úÖ API Healthy</div><div style="font-size: 12px;">${response.data.service} v${response.data.version}</div>`;
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">‚ùå API Error: ${error.message}</div>`;
            }
        }

        async function loadQuickStats() {
            const statsDiv = document.getElementById('quick-stats');
            try {
                const [templates, syndicates] = await Promise.all([
                    http.get('/v1/templates'),
                    http.get('/v1/sindicatos')
                ]);
                
                statsDiv.innerHTML = `
                    <div class="small-card">
                        <div><strong>üìã Templates:</strong> ${templates.data.length}</div>
                        <div><strong>üèõÔ∏è Syndicates:</strong> ${syndicates.data.length}</div>
                        <div><strong>üéØ Status:</strong> <span class="success">Active</span></div>
                    </div>
                `;
            } catch (error) {
                statsDiv.innerHTML = `<div class="error">Error loading stats</div>`;
            }
        }

        async function loadTemplates() {
            const templatesDiv = document.getElementById('templates-list');
            try {
                const response = await http.get('/v1/templates');
                const templates = response.data;
                
                let html = '';
                templates.forEach(template => {
                    html += `
                        <div class="small-card">
                            <strong>${template.nome_template}</strong>
                            <div style="font-size: 12px; color: #6b7280; margin: 4px 0;">
                                ${template.tarefas.length} tasks: ${template.tarefas.slice(0, 2).join(', ')}${template.tarefas.length > 2 ? '...' : ''}
                            </div>
                            <button class="green" onclick="applyTemplate(${template.id})" style="padding: 4px 8px; font-size: 12px;">
                                Apply
                            </button>
                        </div>
                    `;
                });
                templatesDiv.innerHTML = html || '<div>No templates found.</div>';
            } catch (error) {
                templatesDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function applyTemplate(templateId) {
            try {
                const response = await http.post('/v1/controles/aplicar-template', {
                    template_id: templateId,
                    mes: parseInt(document.getElementById('month-select').value),
                    ano: parseInt(document.getElementById('year-select').value),
                    empresas_ids: null
                });
                alert(`‚úÖ ${response.data.message}`);
                loadMonthlyControls();
            } catch (error) {
                alert(`‚ùå Error: ${error.response?.data?.detail || error.message}`);
            }
        }

        async function loadMonthlyControls() {
            const summaryDiv = document.getElementById('controls-summary');
            const controlsDiv = document.getElementById('controls-list');
            const year = document.getElementById('year-select').value;
            const month = document.getElementById('month-select').value;
            
            try {
                const response = await http.get(`/v1/controles/${year}/${month}`);
                const data = response.data;
                
                summaryDiv.innerHTML = `
                    <div class="small-card" style="background: #dbeafe;">
                        <strong>üìä Summary:</strong> ${data.sumario.controles_iniciados}/${data.sumario.total_empresas} controls (${data.sumario.percentual_conclusao})
                    </div>
                `;
                
                let html = '';
                data.controles.forEach(control => {
                    const completedTasks = control.tarefas.filter(t => t.concluido).length;
                    const totalTasks = control.tarefas.length;
                    const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                    
                    html += `
                        <div class="small-card">
                            <strong>${control.nome_empresa}</strong>
                            <div class="progress"><div class="progress-bar" style="width: ${progress}%"></div></div>
                            <div style="font-size: 12px;">${completedTasks}/${totalTasks} tasks (${progress}%)</div>
                        </div>
                    `;
                });
                controlsDiv.innerHTML = html || '<div>No controls for this period.</div>';
            } catch (error) {
                controlsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function uploadPayrollPDF() {
            const fileInput = document.getElementById('payroll-file');
            const resultsDiv = document.getElementById('payroll-results');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            try {
                resultsDiv.innerHTML = '<div class="info">üîÑ Processing payroll PDF with AI...</div>';
                
                const formData = new FormData();
                formData.append('arquivo_pdf', file);
                
                const empresaId = document.getElementById('payroll-empresa').value;
                const mes = document.getElementById('payroll-month').value;
                const ano = document.getElementById('payroll-year').value;
                
                const response = await http.post(`/v1/folha/auditar?empresa_id=${empresaId}&mes=${mes}&ano=${ano}`, formData);
                const audit = response.data;
                
                let html = `
                    <div class="card">
                        <h4>üìä Audit Results</h4>
                        <div><strong>Employees:</strong> ${audit.total_funcionarios}</div>
                        <div><strong>Issues Found:</strong> <span class="warning">${audit.total_divergencias}</span></div>
                        <div><strong>Status:</strong> <span class="status-badge status-completed">${audit.status_processamento}</span></div>
                `;
                
                if (audit.divergencias && audit.divergencias.length > 0) {
                    html += '<div style="margin-top: 10px;"><strong>Key Issues:</strong>';
                    audit.divergencias.slice(0, 3).forEach(div => {
                        const typeClass = div.tipo_divergencia === 'ALERTA' ? 'error' : div.tipo_divergencia === 'AVISO' ? 'warning' : 'info';
                        html += `
                            <div style="font-size: 12px; margin: 4px 0;" class="${typeClass}">
                                ${div.tipo_divergencia}: ${div.nome_funcionario} - ${div.descricao_divergencia}
                            </div>
                        `;
                    });
                    if (audit.divergencias.length > 3) {
                        html += `<div style="font-size: 12px; color: #6b7280;">... and ${audit.divergencias.length - 3} more issues</div>`;
                    }
                    html += '</div>';
                }
                
                html += '</div>';
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">‚ùå Processing failed: ${error.response?.data?.detail || error.message}</div>`;
            }
        }

        async function uploadLegislationPDF() {
            const fileInput = document.getElementById('legislation-file');
            const resultsDiv = document.getElementById('legislation-results');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            try {
                resultsDiv.innerHTML = '<div class="info">üîÑ Extracting legislation data with AI...</div>';
                
                const formData = new FormData();
                formData.append('arquivo_pdf', file);
                
                const response = await http.post('/v1/legislacao/extrair-pdf', formData);
                const extraction = response.data;
                
                let html = `
                    <div class="card">
                        <h4>üìö Document Analysis</h4>
                        <div><strong>Type:</strong> ${extraction.dados_extraidos.tipo_documento.toUpperCase()}</div>
                        <div><strong>Title:</strong> ${extraction.dados_extraidos.titulo}</div>
                        <div><strong>Confidence:</strong> <span class="success">${(extraction.confidence_score * 100).toFixed(1)}%</span></div>
                        <div><strong>Processing Time:</strong> ${extraction.processamento_tempo_segundos.toFixed(2)}s</div>
                `;
                
                if (extraction.sugestoes_validacao && extraction.sugestoes_validacao.length > 0) {
                    html += '<div style="margin-top: 8px;"><strong>Validation Suggestions:</strong>';
                    extraction.sugestoes_validacao.slice(0, 2).forEach(suggestion => {
                        html += `<div style="font-size: 12px; color: #6b7280;">‚Ä¢ ${suggestion}</div>`;
                    });
                    html += '</div>';
                }
                
                html += '</div>';
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">‚ùå Extraction failed: ${error.response?.data?.detail || error.message}</div>`;
            }
        }

        async function loadSyndicates() {
            const syndicatesDiv = document.getElementById('syndicates-list');
            try {
                const response = await http.get('/v1/sindicatos');
                const syndicates = response.data;
                
                let html = '';
                syndicates.forEach(syndicate => {
                    html += `
                        <div class="small-card">
                            <strong>${syndicate.nome_sindicato}</strong>
                            <div style="font-size: 12px; color: #6b7280;">
                                ${syndicate.base_territorial} - ${syndicate.categoria_representada}
                            </div>
                        </div>
                    `;
                });
                syndicatesDiv.innerHTML = html || '<div>No syndicates found.</div>';
            } catch (error) {
                syndicatesDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function analyzeRisk() {
            const resultsDiv = document.getElementById('risk-results');
            const empresaId = document.getElementById('risk-empresa').value;
            
            try {
                resultsDiv.innerHTML = '<div class="info">üîÑ Analyzing risk with AI...</div>';
                
                const response = await http.post('/v1/riscos/analisar', {
                    empresa_id: parseInt(empresaId)
                });
                
                const analysis = response.data;
                const riskClass = analysis.score_risco >= 80 ? 'risk-low' : 
                                 analysis.score_risco >= 60 ? 'risk-medium' : 'risk-high';
                
                let html = `
                    <div class="card">
                        <h4>${analysis.empresa_nome}</h4>
                        <div style="font-size: 18px; font-weight: bold;" class="${riskClass}">
                            Risk Score: ${analysis.score_risco}/100 (${analysis.nivel_risco})
                        </div>
                        <div style="font-size: 12px; margin-top: 8px;">
                            üî¥ Critical: ${analysis.riscos_criticos} | üü° Medium: ${analysis.riscos_medios} | üü¢ Low: ${analysis.riscos_baixos}
                        </div>
                `;
                
                if (analysis.riscos_encontrados && analysis.riscos_encontrados.length > 0) {
                    html += '<div style="margin-top: 8px;"><strong>Top Risks:</strong>';
                    analysis.riscos_encontrados.slice(0, 2).forEach(risk => {
                        html += `<div style="font-size: 12px; margin: 4px 0;">${risk.categoria}: ${risk.tipo_risco}</div>`;
                    });
                    html += '</div>';
                }
                
                html += '</div>';
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">‚ùå Analysis failed: ${error.message}</div>`;
            }
        }

        // Initialize page
        window.addEventListener('DOMContentLoaded', function() {
            checkAPIStatus();
            loadQuickStats();
            loadTemplates();
            loadMonthlyControls();
            loadSyndicates();
        });
    </script>
</body>
</html>