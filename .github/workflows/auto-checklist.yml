# .github/workflows/auto-checklist.yml
name: Auditoria Autom√°tica dos Workflows

on:
  schedule:
    - cron: "0 7 * * *"
  workflow_dispatch:

jobs:
  checklist:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: List Workflows
        run: ls -lh .github/workflows/
        
      - name: Verificar Execu√ß√£o dos Workflows
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Verificando √∫ltimas execu√ß√µes dos workflows..."
          gh run list --limit 20 --json name,status,conclusion,createdAt || echo "N√£o foi poss√≠vel acessar as execu√ß√µes via API"
          
      - name: Validar Estrutura de Workflows
        run: |
          echo "üìã Checklist de Valida√ß√£o dos Workflows:"
          echo "=========================================="
          
          # Verificar se todos os workflows esperados est√£o presentes
          workflows=(
            "atualiza-lista-arquivos.yml"
            "automation.yml"
            "ci-cd.yml"
            "genome-guardian.yml"
            "health-check.yml"
            "iai-c-health-monitor.yml"
            "jekyll-gh-pages.yml"
            "master-checklist-validation.yml"
            "sync-wiki.yml"
          )
          
          missing_workflows=()
          for workflow in "${workflows[@]}"; do
            if [ -f ".github/workflows/$workflow" ]; then
              echo "‚úÖ $workflow - Presente"
            else
              echo "‚ùå $workflow - AUSENTE"
              missing_workflows+=("$workflow")
            fi
          done
          
          # Verificar arquivos de documenta√ß√£o cr√≠ticos
          critical_docs=(
            "README.md"
            "CHANGELOG.md"
            "MANUAL_SUPREMO.md"
            "VALIDATION_CHECKLIST.md"
          )
          
          echo ""
          echo "üìö Documenta√ß√£o Cr√≠tica:"
          echo "========================"
          for doc in "${critical_docs[@]}"; do
            if [ -f "$doc" ]; then
              echo "‚úÖ $doc - Presente"
            else
              echo "‚ùå $doc - AUSENTE"
            fi
          done
          
          # Verificar estrutura de diret√≥rios essenciais
          echo ""
          echo "üèóÔ∏è Estrutura de Diret√≥rios:"
          echo "============================"
          essential_dirs=(
            "src"
            "tests"
            "scripts"
            "api"
            "docs"
          )
          
          for dir in "${essential_dirs[@]}"; do
            if [ -d "$dir" ]; then
              echo "‚úÖ $dir/ - Presente"
            else
              echo "‚ùå $dir/ - AUSENTE"
            fi
          done
          
          # Verificar configura√ß√µes de seguran√ßa
          echo ""
          echo "üîí Seguran√ßa e Compliance:"
          echo "=========================="
          security_files=(
            ".github/dependabot.yml"
            ".pre-commit-config.yaml"
            ".gitignore"
          )
          
          for file in "${security_files[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úÖ $file - Presente"
            else
              echo "‚ùå $file - AUSENTE"
            fi
          done
          
          # Relat√≥rio final
          echo ""
          echo "üìä RESUMO DA AUDITORIA:"
          echo "======================="
          if [ ${#missing_workflows[@]} -eq 0 ]; then
            echo "‚úÖ Todos os workflows cr√≠ticos est√£o presentes"
          else
            echo "‚ö†Ô∏è Workflows ausentes: ${missing_workflows[*]}"
          fi
          
      - name: Gerar Relat√≥rio de Status
        run: |
          echo "# Relat√≥rio de Auditoria dos Workflows - $(date)" > workflow_audit_report.md
          echo "" >> workflow_audit_report.md
          echo "## Status Geral" >> workflow_audit_report.md
          echo "- Data da verifica√ß√£o: $(date)" >> workflow_audit_report.md
          echo "- Total de workflows: $(ls .github/workflows/*.yml | wc -l)" >> workflow_audit_report.md
          echo "- Reposit√≥rio: ${{ github.repository }}" >> workflow_audit_report.md
          echo "" >> workflow_audit_report.md
          echo "## Pr√≥ximos Passos" >> workflow_audit_report.md
          echo "- [ ] Verificar workflows com falhas recorrentes" >> workflow_audit_report.md
          echo "- [ ] Atualizar documenta√ß√£o se necess√°rio" >> workflow_audit_report.md
          echo "- [ ] Revisar configura√ß√µes de seguran√ßa" >> workflow_audit_report.md
          
      - name: Upload Relat√≥rio
        uses: actions/upload-artifact@v4
        with:
          name: workflow-audit-report-${{ github.run_number }}
          path: workflow_audit_report.md
          retention-days: 30