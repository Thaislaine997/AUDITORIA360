# Workflow para AtualizaÃ§Ã£o AutomÃ¡tica da Lista de Arquivos
# 
# Este workflow automatiza a geraÃ§Ã£o de um arquivo lista_arquivos.txt contendo
# uma listagem atualizada de todos os arquivos presentes no repositÃ³rio.
# 
# Funcionalidades:
# - Executa diariamente Ã s 09:00 UTC via cron schedule
# - Executa automaticamente em push para qualquer branch
# - Gera o arquivo usando o comando: find . -type f | sort
# - Sobrescreve o arquivo existente a cada execuÃ§Ã£o
# - Faz commit e push automÃ¡tico apenas se houver diferenÃ§as
# - Evita loops infinitos ao nÃ£o disparar em commits prÃ³prios
#
# Arquivo gerado: lista_arquivos.txt (na raiz do repositÃ³rio)
# 
# Autor: GitHub Actions Automation
# Data: 2024

name: Atualizar Lista de Arquivos

on:
  # Executa diariamente Ã s 09:00 UTC
  schedule:
    - cron: '0 9 * * *'
  
  # Executa em push para qualquer branch, exceto commits do prÃ³prio workflow
  push:
    branches: ['**']
  
  # Permite execuÃ§Ã£o manual via interface web
  workflow_dispatch:

jobs:
  atualizar-lista-arquivos:
    runs-on: ubuntu-latest
    
    # Evita execuÃ§Ã£o desnecessÃ¡ria em commits automÃ¡ticos do workflow
    if: "!contains(github.event.head_commit.message, '[skip-file-list]')"
    
    steps:
      # Checkout do cÃ³digo com token para permitir commits
      - name: Checkout do repositÃ³rio
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      # Configura git para commits automÃ¡ticos
      - name: Configurar Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
      
      # Gera a lista atualizada de arquivos
      - name: Gerar lista de arquivos
        run: |
          echo "ğŸ” Gerando lista atualizada de arquivos..."
          find . -type f | sort > lista_arquivos.txt
          echo "âœ… Lista gerada com $(wc -l < lista_arquivos.txt) arquivos"
      
      # Verifica se houve mudanÃ§as no arquivo
      - name: Verificar mudanÃ§as
        id: changes
        run: |
          if git diff --quiet lista_arquivos.txt; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  Nenhuma mudanÃ§a detectada na lista de arquivos"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ MudanÃ§as detectadas na lista de arquivos"
            echo "EstatÃ­sticas das mudanÃ§as:"
            git diff --stat lista_arquivos.txt || true
          fi
      
      # Commit e push apenas se houver mudanÃ§as
      - name: Commit e push das mudanÃ§as
        if: steps.changes.outputs.changed == 'true'
        run: |
          echo "ğŸ’¾ Fazendo commit das mudanÃ§as..."
          git add lista_arquivos.txt
          git commit -m "Atualizar lista de arquivos automaticamente [skip-file-list]
          
          - Lista atualizada com $(wc -l < lista_arquivos.txt) arquivos
          - Gerada automaticamente via GitHub Actions
          - Data: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          echo "ğŸš€ Fazendo push das mudanÃ§as..."
          git push
          
          echo "âœ… Lista de arquivos atualizada com sucesso!"
      
      # Log de conclusÃ£o
      - name: Log de conclusÃ£o
        run: |
          if [ "${{ steps.changes.outputs.changed }}" = "true" ]; then
            echo "ğŸ‰ Workflow concluÃ­do: arquivo lista_arquivos.txt atualizado"
          else
            echo "âœ¨ Workflow concluÃ­do: nenhuma atualizaÃ§Ã£o necessÃ¡ria"
          fi
          echo "ğŸ“Š Total de arquivos no repositÃ³rio: $(wc -l < lista_arquivos.txt)"